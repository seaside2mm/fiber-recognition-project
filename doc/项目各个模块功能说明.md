# 项目各个模块功能说明

**目录**

[TOC]

## 1. 视频模块设计 

### 图像相似度计算 

**Step1**: 

我们利用帧相似性算法逐帧检查前后两帧相似性或差异。 最常用的算法是PSNR（又名峰值信噪比）与MSE（均方误差）。 

- MSE(*mean squad error*)

  这个想法比较简单，比较两个图像`I1`和`I2`， 其具有二维大小`i`和`j`，由`c`个通道组成。求两个图像间的平均误差。并返回每一个通道的平均误差。

​                                                 $$MSE = \frac{1}{c*i*j} \sum{(I_1-I_2)^2}$$

- PSNR（*Peak signal-to-noise ratio*）

  这里MAXI是像素的最大有效值。 如果每个通道的每个像素有简单的单字节图像，则这是255.当两幅图像相同时，MSE将给出零，从而导致PSNR公式中的无效除零运算。 在这种情况下，PSNR是不确定的，因为我们需要单独处理这种情况。 由于像素值具有非常宽的动态范围，因此转换为对数标度。

​                                                    $$PSNR = 10 \cdot \log_{10} \left( \frac{MAX_I^2}{MSE} \right)$$

**Step2**: 

抽取视频前后两帧，分别计算相似度。并且最后返回全部帧相似度的平均值，根据设定一个合理的阈值，返回`bool值`，判断视频是否关联。



## 2.图像模块设计

包括圆检测，清晰度检测，圆心距离计算三个主要子模块，分别输出相应的内部API接口，以供控制模块调用。

下图表示为整体帧模块设计图。

![Screen Shot 2018-06-13 at 9.28.37 PM](/Users/kubota/Jupyter/github-photos/project/Screen Shot 2018-06-13 at 9.28.37 PM.png)



###  (1) 圆检测

在许多应用场合中需要快速准确地检测出直线或者圆。其中一种非常有效的解决问题的方法是霍夫变换，Hough变换的基本原理在于利用点与线的对偶性，将原始图像空间的给定的曲线通过曲线表达形式变为参数空间的一个点。这样就把原始图像中给定曲线的检测问题转化为寻找参数空间中的峰值问题。

![Screen Shot 2018-06-08 at 3.41.14 PM](/Users/kubota/Jupyter/github-photos/project/Screen Shot 2018-06-08 at 3.41.14 PM.png)



 

### (2) 清晰度检测

清晰度检测算法，基于图像梯度大小，计算图像焦点是否对焦。其中`Gx`和`Gy`是通过将给定图像`I`利用Sobel算子进行卷积计算，出的X和Y图像梯度。其结果越小，清晰度越好。

​                                     $$ϕx,y=∑(i,j)∈Ω(x,y)(G_x(i,j)^2+G_y(i,j)^2)$$     

下图利用均一化方法，针对一段视频，将清晰度表示为`[0,1]`范围得到的结果。

​                                                     $$x^* = \frac{x-min}{max-min}$$ 

![download](/Users/kubota/Jupyter/github-photos/project/download.png)

根据最小值可以基本判定锐度值最高图像。取出第18帧，根据图像来看，也可以看出其为最清晰图像。

![左圆先顺时针到头再逆时针（右圆模糊重叠1）.avi_20180124_161634.306](/Users/kubota/Jupyter/github-photos/project/左圆先顺时针到头再逆时针（右圆模糊重叠1）.avi_20180124_161634.306.bmp)



###  (3)圆心距离基准距离

**项目要求**：对于聚焦好的圆的分析可以给出拟合圆的直径像素数（或拟合圆边界曲线），圆心的屏幕坐标，圆心与方框图在上下、左右两方向的正负像素差值。 

考虑到圆心坐标距离方框图在上下左右两方向距离等价于与方框图中心的距离。所以先考虑与基准点距离。

**主要方法**：

####  i. 寻找基准点坐标

- 转换hsv颜色空间，将BGR格式转成HSV格式，便于针对各个颜色范围提取。

![Screen Shot 2018-06-07 at 9.07.27 AM](/Users/kubota/Jupyter/github-photos/project/Screen Shot 2018-06-07 at 9.07.27 AM.png)

- 获取mask

 利用HSV模型中蓝色范围的上下界获取mask，mask中原视频中的蓝色部分会被弄成白色，其他部分黑色。

```
蓝色mask的hsv范围
lower_blue: [100,43,46]
upper_blue: [124,255,255]

红色mask的hsv范围
lower_red:[0,43,46]
upper_red:[10,255,255]
```

![Screen Shot 2018-06-07 at 9.07.44 AM](/Users/kubota/Jupyter/github-photos/project/Screen Shot 2018-06-07 at 9.07.44 AM.png) 

- 图像按位操作

 利用`图像位操作算法`，即对图像（灰度图像或彩色图像均可）每个像素值进行二进制“与”操作。将mask于原视频帧进行按位与操作，则会把mask中的白色用真实的图像替换：

![Screen Shot 2018-06-07 at 9.13.25 AM](/Users/kubota/Jupyter/github-photos/project/Screen Shot 2018-06-07 at 9.13.25 AM.png)

- 从hsv颜色空间转换到rgb再到灰度空间，利用霍夫直线检测算法检测直线，并画出直线。 

![Screen Shot 2018-06-06 at 8.07.34 PM](/Users/kubota/Jupyter/github-photos/project/Screen Shot 2018-06-06 at 8.07.34 PM.png)



#### ii. 计算圆心与基准点距离

 根据直线坐标，可以找出基准点的x,y坐标。目前的问题主要有，只能显示全部直线，然后通过自己推断选择出坐标。然后考虑在每一帧基准点位置不变，所以将其作为存储为参数，直接传入计算圆心距离图框中心点函数。然后简单利用圆心坐标与基准点坐标相减，可以算出距离。

 

## 3.场景模块设计

**项目要求**：分析算法可以针对以下4种场景：

- 两个圆都在画面中，且不重叠，分别计算两个圆的清晰度评价值、圆心坐标、圆直径像素数；
- 只有一个圆在画面中，计算一个圆的清晰度评价值，并提示缺少一个圆。

- 两个圆都在画面中，且部分重叠（不完全重叠），在提示重叠情况下，还是可以扑捉两个圆；而在移动一个圆时，可 以跟踪捕捉。
- 两个圆都不在画面，直接提示缺少两个圆。

**方法**：将不同场景的视频帧分成四种，针对每一种常用调用不同的图像模块内部接口函数，输出相应场景信息。 

## 4.控制模块设计

**项目要求**：

- 对一组视屏流的图像分析，可以找出聚焦最好的画面，并呈现出来。 

控制模块导入视频模块、图像模块、场景模块，利用内部API接口做场景检测与最优帧检测。这两个API接口面向用户。

![Screen Shot 2018-06-13 at 9.28.52 PM](/Users/kubota/Jupyter/github-photos/project/Screen Shot 2018-06-13 at 9.28.52 PM.png)

- 场景检测控制

  输入帧，并且检测图像的圆，根据圆的数量进行判断，分别调用场景模块，输出每一种情况的值。

- 最优帧检测控制

  传入视频地址，检测视频链接是否正确且不为空。提取每一帧，计算帧的清晰度值，并存储在一个向量。视频所有帧计算完成后，计算最优清晰度的帧，并检测圆，输出相应信息。



## TODO

- 视频图像间的关联度(已完成80%）。
- 系统整合阶段(已完成70%）。
3.     算法优化。